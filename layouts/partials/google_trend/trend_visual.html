{{ $trend_paths := getJSON "https://sm-google-trend-public.s3.eu-central-1.amazonaws.com/agg/metadata.json" }}

{{ $cat := "0" }}
{{ $timeframe := "today 5-y" }}

{{ $keywords := slice }}
{{ $geo := slice }}
{{ with $trend_paths }}
  {{ range . }}
      {{ $keywords = $keywords | append (index . "keyword") }}
      {{ $geo = $geo | append (index . "geo") }}
  {{ end }}
{{ end }}

{{ $keywords = $keywords | uniq }}
{{ $geo = $geo | uniq }}

<select id="selected_geo">
  <option value="{{ index $geo 0 | lower }}" selected="selected">{{ i18n (index $geo 0) }}</option>
  {{ with after 1 $geo }}
    {{ range . }}
    <option value="{{ . | lower }}" selected="selected">{{ i18n . }}</option>
    {{ end }}
  {{ end }}
</select>
<select id="selected_keyword">
  <option value='{{ replace (index $keywords 0) " " "-" }}' selected="selected">{{ index $keywords 0 }}</option>
  {{ with after 1 $keywords }}
    {{ range . }}
      <option value='{{ replace . " " "-" }}'>{{ . }}</option>
    {{ end }}
  {{ end }}
</select>

<div id="trend-chart" ></div>

<script>
function visualizeTrend(jsonUrl, query) {
  d3.json(jsonUrl)
.then(function (data) {
  console.log(data)

  x = data.map( function(item) { return item.date })
  y = data.map( function(item) { return item.value })
  {{/*  query = data.map( function(item) {return item.query })[0]  */}}

  var data = [
    {
      x: x,
      y: y,
      type: 'line',
      marker: {
        color: 'rgb(0,0,0,0.125)',
        opacity: 0.7,
      }
    }
  ];
  var layout = {
    title: "Weekly Trend for " + query,
  };

  Plotly.newPlot('trend-chart', data, layout, {displayModeBar: false});

})
.catch(function (error) {
  console.log(error)
});
}

let selectedKW = '{{ replace (index $keywords 0) " " "-" }}'
let selectedGeo = '{{ index $geo 0 | lower }}'

let selectingGeoList = document.getElementById('selected_geo');
    selectingGeoList.onchange = (ev) =>{
      let selecetedGeoIndex = selectingGeoList.selectedIndex;
      console.log("Selected index is: " + selecetedGeoIndex);
      let selectedGeoOption = selectingGeoList.options[selecetedGeoIndex];
      console.log("Selected option is: " + selectedGeoOption.outerHTML);
      console.log("Selected value is: " + selectedGeoOption.value);
      console.log("Selected text is: " + selectedGeoOption.text);
      selectedGeo = selectedGeoOption.value

      {{/*  visualizeTrendFor(selectedKW, selectedGeo)  */}}
      visualizeTrendUsingUrl(selectedKW, selectedGeo)
    }

let selectingKWList = document.getElementById('selected_keyword');
  selectingKWList.onchange = (ev) =>{
      let selecetedKWIndex = selectingKWList.selectedIndex;
      console.log("Selected index is: " + selecetedKWIndex);
      let selectedKWOption = selectingKWList.options[selecetedKWIndex];
      console.log("Selected option is: " + selectedKWOption.outerHTML);
      console.log("Selected value is: " + selectedKWOption.value);
      console.log("Selected text is: " + selectedKWOption.text);
      selectedKW = selectedKWOption.value

      {{/*  visualizeTrendFor(selectedKW, selectedGeo)  */}}
      visualizeTrendUsingUrl(selectedKW, selectedGeo)
    }


function visualizeTrendFor (keyword, geo) {
  var jsonUrl = "https://sm-google-trend-public.s3.eu-central-1.amazonaws.com/agg/keyword=" + keyword + "/cat=0/geo=" + geo + "/timeframe=today-5-y/format=json/snapshot_date=latest/data.json"

  visualizeTrend(jsonUrl, keyword)
}

{{/*  visualizeTrendFor(selectedKW, selectedGeo)  */}}

d3.json("/trends.json")
.then(function (data) {
  console.log("trends.json")
  console.log(data)
  let trend_id = selectedKW + "-0-" + selectedGeo.toUpperCase() + "-today 5-y"
  console.log(trend_id)
  visualizeTrend(data[trend_id], selectedKW)
})
.catch(function (error) {
  console.log(error)
});

function visualizeTrendUsingUrl (keyword, geo) {
d3.json("/trends.json")
.then(function (data) {
  console.log("trends.json")
  console.log(data)
  let trend_id = keyword + "-0-" + geo.toUpperCase() + "-today 5-y"
  console.log(trend_id)
  visualizeTrend(data[trend_id], keyword)
})
.catch(function (error) {
  console.log(error)
});
}
</script>







